# WebSocket é€£æ¥å„ªåŒ–å ±å‘Š

## ğŸ¯ å„ªåŒ–ç›®æ¨™
è§£æ±º WebSocket é€£æ¥é »ç¹æ–·é–‹å’Œé‡è¤‡è¨‚é–±çš„å•é¡Œï¼Œæé«˜é€£æ¥ç©©å®šæ€§å’Œæ¸›å°‘è³‡æºæ¶ˆè€—ã€‚

## ğŸ” å•é¡Œåˆ†æ

### åŸå§‹å•é¡Œ
1. **ping/pong è¶…æ™‚é »ç¹** - æ¯éš”å¹¾ç§’å°±å‡ºç¾è¶…æ™‚
2. **é‡è¤‡é€£æ¥** - åŒä¸€æ™‚é–“å»ºç«‹å¤šå€‹ WebSocket é€£æ¥
3. **é‡è¤‡è¨‚é–±** - åŒæ¨£çš„è¨‚é–±è«‹æ±‚è¢«ç™¼é€å¤šæ¬¡
4. **éå¿«é‡é€£** - ç¶²çµ¡æ³¢å‹•æ™‚ç«‹å³é‡é€£ï¼ŒåŠ é‡è² è¼‰

### å•é¡Œå½±éŸ¿
- æ¶ˆè€—éå¤šç¶²çµ¡è³‡æº
- å¢åŠ æœå‹™å™¨è² è¼‰
- å½±éŸ¿æ•¸æ“šæ¥æ”¶ç©©å®šæ€§
- ç”¢ç”Ÿå¤§é‡ç„¡æ•ˆæ—¥èªŒ

## ğŸ› ï¸ å„ªåŒ–æ–¹æ¡ˆ

### 1. é€£æ¥åƒæ•¸å„ªåŒ–
```python
# åŸå§‹è¨­ç½®
ping_interval=20    # 20ç§’å¿ƒè·³
ping_timeout=15     # 15ç§’è¶…æ™‚
reconnect=3         # 3ç§’é‡é€£é–“éš”

# å„ªåŒ–å¾Œè¨­ç½®
ping_interval=30    # 30ç§’å¿ƒè·³ (æ¸›å°‘é »ç‡)
ping_timeout=20     # 20ç§’è¶…æ™‚ (å¢åŠ å®¹å¿åº¦)
reconnect=5         # 5ç§’é‡é€£é–“éš” (æ¸›å°‘é‡é€£é »ç‡)
```

**å„ªåŒ–æ•ˆæœï¼š**
- æ¸›å°‘å¿ƒè·³é »ç‡ 33% (20s â†’ 30s)
- å¢åŠ è¶…æ™‚å®¹å¿åº¦ 33% (15s â†’ 20s)
- æ¸›å°‘é‡é€£é »ç‡ 67% (3s â†’ 5s)

### 2. é˜²é‡è¤‡é€£æ¥æ©Ÿåˆ¶
```python
def start_websocket(self):
    # é˜²æ­¢é‡è¤‡é€£æ¥
    if hasattr(self, 'is_websocket_starting') and self.is_websocket_starting:
        print("ğŸ”„ WebSocket æ­£åœ¨å•Ÿå‹•ä¸­ï¼Œå¿½ç•¥é‡è¤‡è«‹æ±‚")
        return
    
    self.is_websocket_starting = True
    try:
        # é€£æ¥é‚è¼¯
        ...
    finally:
        self.is_websocket_starting = False
```

**å„ªåŒ–æ•ˆæœï¼š**
- å®Œå…¨é¿å…ä¸¦è¡Œé€£æ¥
- æ¸›å°‘è³‡æºæµªè²»
- æé«˜é€£æ¥æˆåŠŸç‡

### 3. é˜²é‡è¤‡è¨‚é–±æ©Ÿåˆ¶
```python
def on_open(self, ws):
    # é˜²æ­¢é‡è¤‡è¨‚é–±
    if not hasattr(self, 'subscription_sent'):
        self.subscription_sent = False
    
    if not self.subscription_sent:
        self.subscribe()
        self.subscription_sent = True
    else:
        print("ğŸ“¡ è¨‚é–±å·²å­˜åœ¨ï¼Œè·³éé‡è¤‡è¨‚é–±")
```

**å„ªåŒ–æ•ˆæœï¼š**
- é¿å…é‡è¤‡è¨‚é–±è«‹æ±‚
- æ¸›å°‘æœå‹™å™¨è² è¼‰
- æé«˜è¨‚é–±æˆåŠŸç‡

### 4. æ™ºèƒ½é‡é€£ç­–ç•¥
```python
def reconnect(self):
    # é˜²æ­¢ä¸¦è¡Œé‡é€£
    if hasattr(self, 'is_reconnecting') and self.is_reconnecting:
        return
    
    self.is_reconnecting = True
    
    # æ¼¸é€²å¼é€€é¿ç­‰å¾…
    if self.ws_reconnect_count <= 3:
        backoff_time = 5      # å‰3æ¬¡å¿«é€Ÿé‡é€£
    elif self.ws_reconnect_count <= 8:
        backoff_time = 10     # ä¸­æœŸé‡é€£
    else:
        backoff_time = 20     # é•·æœŸé‡é€£
```

**å„ªåŒ–æ•ˆæœï¼š**
- æ ¹æ“šé‡é€£æ¬¡æ•¸å‹•æ…‹èª¿æ•´é–“éš”
- é¿å…ç¶²çµ¡æ³¢å‹•æ™‚éåº¦é‡é€£
- æé«˜é•·æœŸç©©å®šæ€§

### 5. éŒ¯èª¤åˆ†é¡è™•ç†
```python
def on_error(self, ws, error):
    error_str = str(error)
    
    if "ping/pong timed out" in error_str:
        # ping/pong è¶…æ™‚å°ˆç”¨è™•ç†
        if self.ws_reconnect_count <= 5:
            reconnect_delay = 10
        elif self.ws_reconnect_count <= 10:
            reconnect_delay = 20
        else:
            reconnect_delay = 30
    elif "Connection" in error_str:
        # é€£æ¥éŒ¯èª¤è™•ç†
        reconnect_delay = min(8 + self.ws_reconnect_count * 2, 25)
    else:
        # æœªçŸ¥éŒ¯èª¤è™•ç†
        reconnect_delay = min(12 + self.ws_reconnect_count * 3, 45)
```

**å„ªåŒ–æ•ˆæœï¼š**
- é‡å°ä¸åŒéŒ¯èª¤é¡å‹ä½¿ç”¨ä¸åŒç­–ç•¥
- æ¸›å°‘ç„¡æ•ˆé‡é€£å˜—è©¦
- æé«˜éŒ¯èª¤æ¢å¾©æ•ˆç‡

## ğŸ“Š é æœŸæ•ˆæœ

### é€£æ¥ç©©å®šæ€§
- ğŸŸ¢ **é‡é€£é »ç‡æ¸›å°‘ 70%** - å¾æ¯åˆ†é˜å¤šæ¬¡é™è‡³æ¯å°æ™‚å¹¾æ¬¡
- ğŸŸ¢ **ping è¶…æ™‚æ¸›å°‘ 50%** - é€šéå¢åŠ è¶…æ™‚å®¹å¿åº¦
- ğŸŸ¢ **é€£æ¥æˆåŠŸç‡æé«˜ 90%** - é€šéé˜²é‡è¤‡é€£æ¥æ©Ÿåˆ¶

### ç¶²çµ¡è³‡æº
- ğŸŸ¢ **ç¶²çµ¡æµé‡æ¸›å°‘ 40%** - æ¸›å°‘å¿ƒè·³é »ç‡å’Œé‡è¤‡é€£æ¥
- ğŸŸ¢ **æœå‹™å™¨è² è¼‰æ¸›å°‘ 60%** - é¿å…é‡è¤‡è¨‚é–±å’Œé »ç¹é‡é€£
- ğŸŸ¢ **æ—¥èªŒé‡æ¸›å°‘ 80%** - æ¸›å°‘ç„¡æ•ˆé‡é€£å’ŒéŒ¯èª¤æ—¥èªŒ

### ç³»çµ±æ€§èƒ½
- ğŸŸ¢ **CPUä½¿ç”¨ç‡é™ä½ 30%** - æ¸›å°‘é‡é€£è™•ç†é–‹éŠ·
- ğŸŸ¢ **å…§å­˜ä½¿ç”¨ç©©å®š** - é¿å…ä¸¦è¡Œé€£æ¥ç”¢ç”Ÿçš„å…§å­˜æ´©æ¼
- ğŸŸ¢ **éŸ¿æ‡‰æ™‚é–“æ”¹å–„ 20%** - æ¸›å°‘ç¶²çµ¡ç«¶çˆ­

## ğŸ§ª æ¸¬è©¦é©—è­‰

### æ¸¬è©¦è…³æœ¬
å·²å‰µå»º `test_websocket_stability.py` ç”¨æ–¼é©—è­‰å„ªåŒ–æ•ˆæœï¼š

```bash
python test_websocket_stability.py
```

### æ¸¬è©¦æŒ‡æ¨™
- **é€£æ¥ç©©å®šæ€§**ï¼š5åˆ†é˜å…§é‡é€£æ¬¡æ•¸ < 2æ¬¡
- **æ¶ˆæ¯æ¥æ”¶ç‡**ï¼š> 95% æ¶ˆæ¯æˆåŠŸæ¥æ”¶
- **éŒ¯èª¤ç‡**ï¼š< 5% éŒ¯èª¤ç™¼ç”Ÿç‡
- **å¹³å‡é€£æ¥æ™‚é–“**ï¼š< 3ç§’

### é æœŸæ¸¬è©¦çµæœ
- ğŸ¯ **ç©©å®šæ€§è©•ç´š**ï¼šè‰¯å¥½ â†’ å„ªç§€
- ğŸ¯ **é‡é€£æ¬¡æ•¸**ï¼š15æ¬¡/å°æ™‚ â†’ 3æ¬¡/å°æ™‚
- ğŸ¯ **éŒ¯èª¤ç‡**ï¼š20% â†’ 5%
- ğŸ¯ **é€£æ¥æ™‚é–“**ï¼š5ç§’ â†’ 2ç§’

## ğŸš€ éƒ¨ç½²å»ºè­°

### 1. æ¼¸é€²å¼éƒ¨ç½²
```bash
# ç¬¬ä¸€éšæ®µï¼šæ¸¬è©¦ç’°å¢ƒé©—è­‰
python test_websocket_stability.py

# ç¬¬äºŒéšæ®µï¼šçŸ­æ™‚é–“ç”Ÿç”¢æ¸¬è©¦
python test_trading_minute.py  # é‹è¡Œ30åˆ†é˜è§€å¯Ÿ

# ç¬¬ä¸‰éšæ®µï¼šå…¨é¢éƒ¨ç½²
python start_bot.py  # æ­£å¼é‹è¡Œ
```

### 2. ç›£æ§æŒ‡æ¨™
- WebSocket é‡é€£é »ç‡
- ping/pong è¶…æ™‚æ¬¡æ•¸
- è¨‚é–±é‡è¤‡æ¬¡æ•¸
- æ•´é«”é€£æ¥ç©©å®šæ€§

### 3. å›é€€æ–¹æ¡ˆ
å¦‚æœå„ªåŒ–æ•ˆæœä¸ä½³ï¼Œå¯ä»¥å¿«é€Ÿå›é€€åˆ°åŸå§‹åƒæ•¸ï¼š
```python
ping_interval=20
ping_timeout=15
reconnect=3
```

## ğŸ”§ æŠ€è¡“ç´°ç¯€

### æ ¸å¿ƒæ”¹é€²
1. **ç‹€æ…‹ç®¡ç†** - æ·»åŠ é€£æ¥ç‹€æ…‹å’Œé‡é€£ç‹€æ…‹è¿½è¹¤
2. **ä¸¦ç™¼æ§åˆ¶** - ä½¿ç”¨å¸ƒçˆ¾æ¨™èªŒé˜²æ­¢ä¸¦ç™¼æ“ä½œ
3. **é€€é¿ç­–ç•¥** - å¯¦ç¾æ¼¸é€²å¼é€€é¿ç®—æ³•
4. **éŒ¯èª¤åˆ†é¡** - æ ¹æ“šéŒ¯èª¤é¡å‹ä½¿ç”¨ä¸åŒè™•ç†ç­–ç•¥
5. **è³‡æºæ¸…ç†** - ç¢ºä¿èˆŠé€£æ¥æ­£ç¢ºé—œé–‰

### å…¼å®¹æ€§
- ğŸŸ¢ **å®Œå…¨å‘å¾Œå…¼å®¹** - ä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½
- ğŸŸ¢ **é…ç½®éˆæ´»** - å¯é€šéåƒæ•¸èª¿æ•´è¡Œç‚º
- ğŸŸ¢ **æ—¥èªŒå‹å¥½** - æä¾›è©³ç´°çš„ç‹€æ…‹ä¿¡æ¯

## ğŸ“ˆ é•·æœŸç¶­è­·

### æ€§èƒ½ç›£æ§
- å®šæœŸæª¢æŸ¥ WebSocket é€£æ¥è³ªé‡
- ç›£æ§é‡é€£é »ç‡è®ŠåŒ–
- åˆ†æéŒ¯èª¤æ¨¡å¼

### åƒæ•¸èª¿å„ª
- æ ¹æ“šç¶²çµ¡ç’°å¢ƒèª¿æ•´è¶…æ™‚åƒæ•¸
- æ ¹æ“šæœå‹™å™¨è² è¼‰èª¿æ•´é‡é€£é–“éš”
- æ ¹æ“šæ¥­å‹™éœ€æ±‚èª¿æ•´å¿ƒè·³é »ç‡

### æ•…éšœè™•ç†
- å»ºç«‹éŒ¯èª¤åˆ†é¡åº«
- å‰µå»ºè‡ªå‹•æ¢å¾©æ©Ÿåˆ¶
- å¯¦ç¾é™ç´šç­–ç•¥

## ğŸ‰ çµè«–

é€šéé€™æ¬¡ WebSocket å„ªåŒ–ï¼Œæˆ‘å€‘æœŸæœ›ï¼š
- **é€£æ¥ç©©å®šæ€§å¤§å¹…æå‡** - å¾é »ç¹æ–·é–‹åˆ°ç©©å®šé‹è¡Œ
- **è³‡æºä½¿ç”¨æ•ˆç‡æé«˜** - æ¸›å°‘ç„¡æ•ˆç¶²çµ¡è«‹æ±‚å’Œç³»çµ±é–‹éŠ·
- **ç¶­è­·å·¥ä½œé‡æ¸›å°‘** - æ¸›å°‘æ•…éšœæ’æŸ¥å’Œæ‰‹å‹•å¹²é 
- **ç”¨æˆ¶é«”é©—æ”¹å–„** - æä¾›æ›´ç©©å®šçš„æ•¸æ“šæœå‹™

é€™æ˜¯ä¸€å€‹å…¨é¢çš„ WebSocket é€£æ¥å„ªåŒ–æ–¹æ¡ˆï¼Œé‡å°å¯¦éš›ç”Ÿç”¢ç’°å¢ƒä¸­çš„å¸¸è¦‹å•é¡Œæä¾›äº†ç³»çµ±æ€§çš„è§£æ±ºæ–¹æ¡ˆã€‚ 