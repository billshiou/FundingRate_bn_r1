# è³‡é‡‘è²»ç‡å¥—åˆ©æ©Ÿå™¨äºº - ç­–ç•¥æ©Ÿåˆ¶èªªæ˜ v1.0.20

## ğŸ¯ æ ¸å¿ƒç­–ç•¥ï¼šæŒ‰éœ€ç²¾æº–æ›´æ–°

### ğŸ“Š ç¯©é¸æ©Ÿåˆ¶æµç¨‹

```
1. WebSocketæ¥æ”¶ â†’ 2. è³‡é‡‘è²»ç‡ç¯©é¸ â†’ 3. æœ€ä½³äº¤æ˜“å°é¸æ“‡ â†’ 4. é»å·®æŒ‰éœ€æ›´æ–° â†’ 5. æœ€çµ‚æ±ºç­–
```

#### 1ï¸âƒ£ ç¬¬ä¸€å±¤ç¯©é¸ï¼šè³‡é‡‘è²»ç‡åˆç¯©
```python
# åªè€ƒæ…®æœ‰æ½›åŠ›çš„äº¤æ˜“å°ï¼ˆé–¾å€¼çš„80%ä»¥ä¸Šï¼‰
if abs_funding_rate >= min_funding_rate * 0.8:
    potential_opportunities.append(...)
```
- **ç›®çš„**ï¼šæ’é™¤æ˜é¡¯ä¸ç¬¦åˆæ¢ä»¶çš„äº¤æ˜“å°
- **æ¨™æº–**ï¼šçµ•å°è³‡é‡‘è²»ç‡ â‰¥ é…ç½®é–¾å€¼çš„80%
- **æ•ˆæœ**ï¼šå¾300+äº¤æ˜“å°ç¸®æ¸›åˆ°ç´„20-50å€‹å€™é¸

#### 2ï¸âƒ£ ç¬¬äºŒå±¤ç¯©é¸ï¼šæœ€ä½³äº¤æ˜“å°é¸æ“‡
```python
# æŒ‰çµç®—æ™‚é–“å„ªå…ˆï¼Œç„¶å¾ŒæŒ‰è³‡é‡‘è²»ç‡æ’åº
potential_opportunities.sort(key=lambda x: (x['next_funding_time'], -x['abs_funding_rate']))
best_candidate = potential_opportunities[0]
```
- **æ’åºé‚è¼¯**ï¼š
  1. çµç®—æ™‚é–“æœ€è¿‘çš„å„ªå…ˆ
  2. ç›¸åŒçµç®—æ™‚é–“ä¸‹ï¼Œè³‡é‡‘è²»ç‡æœ€é«˜çš„å„ªå…ˆ
- **çµæœ**ï¼šé¸å‡ºå”¯ä¸€çš„æœ€ä½³äº¤æ˜“å°

#### 3ï¸âƒ£ ç¬¬ä¸‰å±¤ç¯©é¸ï¼šé»å·®é©—è­‰ï¼ˆæŒ‰éœ€æ›´æ–°ï¼‰
```python
# åªæ›´æ–°æœ€ä½³äº¤æ˜“å°çš„é»å·®
if self._should_update_spread(symbol):
    self.update_single_spread(symbol)

# æœ€çµ‚æª¢æŸ¥æ·¨æ”¶ç›Š
net_profit = abs_funding_rate - spread
if net_profit >= min_funding_rate and spread <= max_spread:
    return best_opportunity
```
- **æŒ‰éœ€æ›´æ–°**ï¼šåªæ›´æ–°è¢«é¸ä¸­äº¤æ˜“å°çš„é»å·®
- **æœ€çµ‚é©—è­‰**ï¼šç¢ºä¿æ·¨æ”¶ç›Šå’Œé»å·®éƒ½ç¬¦åˆæ¢ä»¶

---

## â±ï¸ æ•¸æ“šæ›´æ–°é »ç‡

### ğŸ“¡ WebSocketæ•¸æ“šï¼ˆå¯¦æ™‚æ¨é€ï¼‰
| æ•¸æ“šé¡å‹ | ä¾†æº | æ›´æ–°é »ç‡ | å»¶é² |
|---------|------|----------|------|
| **è³‡é‡‘è²»ç‡** | `!markPrice@arr` | å¯¦æ™‚æ¨é€ | ~50-200ms |
| **æ¨™è¨˜åƒ¹æ ¼** | `!markPrice@arr` | å¯¦æ™‚æ¨é€ | ~50-200ms |
| **çµç®—æ™‚é–“** | `!markPrice@arr` | å¯¦æ™‚æ¨é€ | ~50-200ms |

```python
# WebSocketæ¨é€é »ç‡ï¼šç´„æ¯1-3ç§’æ¨é€ä¸€æ¬¡å…¨é‡æ•¸æ“š
# ç¸½äº¤æ˜“å°æ•¸ï¼š300+å€‹
# æœ‰æ•ˆäº¤æ˜“å°ï¼šä¾æ“šTRADING_SYMBOLSå’ŒEXCLUDED_SYMBOLSç¯©é¸
```

### ğŸ’° é»å·®æ•¸æ“šï¼ˆæŒ‰éœ€æ›´æ–°ï¼‰
| æ›´æ–°ç­–ç•¥ | é »ç‡ | è§¸ç™¼æ¢ä»¶ | APIèª¿ç”¨ |
|---------|------|----------|---------|
| **èˆŠç­–ç•¥** | 50å€‹/30ç§’ | å®šæ™‚æ‰¹é‡ | é«˜é »èª¿ç”¨ |
| **æ–°ç­–ç•¥** | 1å€‹/æŒ‰éœ€ | é¸ä¸­æœ€ä½³äº¤æ˜“å° | **50å€æ¸›å°‘** |

```python
# æŒ‰éœ€æ›´æ–°é‚è¼¯ï¼š
def _should_update_spread(symbol):
    # 30ç§’ç·©å­˜æ©Ÿåˆ¶
    return (current_time - last_update_time >= 30)

# è§¸ç™¼æ™‚æ©Ÿï¼š
# 1. ç•¶å‰äº¤æ˜“å°è¢«é¸ç‚ºæœ€ä½³å€™é¸
# 2. è©²äº¤æ˜“å°çš„é»å·®ç·©å­˜è¶…é30ç§’
# 3. æˆ–è©²äº¤æ˜“å°å¾æœªæ›´æ–°éé»å·®
```

### ğŸ”„ ä¸»å¾ªç’°æª¢æŸ¥é »ç‡
```python
CHECK_INTERVAL = 0.1  # æ¯100msæª¢æŸ¥ä¸€æ¬¡
```
- **é€²å ´æª¢æŸ¥**ï¼šæ¯100msæª¢æŸ¥æ˜¯å¦åˆ°é”é€²å ´æ™‚æ©Ÿ
- **å¹³å€‰æª¢æŸ¥**ï¼šæ¯100msæª¢æŸ¥æ˜¯å¦åˆ°é”å¹³å€‰æ™‚æ©Ÿ
- **å€‰ä½æª¢æŸ¥**ï¼šä¾æ“šé…ç½®é–“éš”æª¢æŸ¥

---

## â° æ™‚é–“å·®è™•ç†æ©Ÿåˆ¶

### ğŸ• æ™‚é–“åŒæ­¥ç³»çµ±
```python
def sync_server_time(self):
    local_time_before = int(time.time() * 1000)
    server_time = self.client.get_server_time()
    local_time_after = int(time.time() * 1000)
    
    # ç¶²è·¯å»¶é²è£œå„Ÿ
    network_delay = local_time_after - local_time_before
    adjusted_local_time = local_time_before + (network_delay / 2)
    
    # è¨ˆç®—æ™‚é–“å·®
    self.time_offset = server_time['serverTime'] - adjusted_local_time
```

#### æ™‚é–“å·®çµ„æˆï¼š
1. **ç¶²è·¯å»¶é²**ï¼šæœ¬åœ°â†”æœå‹™å™¨å¾€è¿”æ™‚é–“
2. **æ™‚é˜åå·®**ï¼šæœ¬åœ°æ™‚é˜èˆ‡æœå‹™å™¨æ™‚é˜å·®ç•°
3. **è™•ç†å»¶é²**ï¼šAPIè«‹æ±‚è™•ç†æ™‚é–“

### âš¡ é€²å ´æ™‚æ©Ÿç²¾æº–æ§åˆ¶
```python
# é…ç½®ç¤ºä¾‹
ENTRY_BEFORE_SECONDS = 0.2  # çµç®—å‰0.2ç§’é€²å ´

# å¯¦éš›è¨ˆç®—ï¼ˆåŒ…å«æ™‚é–“å·®è£œå„Ÿï¼‰
corrected_time = local_time + self.time_offset
time_to_settlement = next_funding_time - corrected_time
should_entry = time_to_settlement <= (ENTRY_BEFORE_SECONDS * 1000)
```

#### æ™‚é–“ç²¾åº¦åˆ†æï¼š
- **ç†è«–ç²¾åº¦**ï¼šÂ±10-50ms
- **ç¶²è·¯å»¶é²å½±éŸ¿**ï¼š50-200ms
- **ç¸½é«”ç²¾åº¦**ï¼šÂ±100-300ms
- **å»ºè­°è¨­å®š**ï¼šâ‰¥200msçš„é€²å ´æå‰æ™‚é–“

---

## ğŸ“ˆ æ•ˆç‡æå‡çµ±è¨ˆ

### ğŸ”„ ç¯©é¸æ•ˆç‡æå‡
| éšæ®µ | èˆŠæ©Ÿåˆ¶ | æ–°æ©Ÿåˆ¶ | æå‡ |
|------|--------|--------|------|
| **äº¤æ˜“å°æ•¸é‡** | 300+å€‹å…¨æƒæ | 20-50å€‹åˆç¯© | **6-15å€** |
| **é»å·®æ›´æ–°** | 50å€‹/30ç§’ | 1å€‹/æŒ‰éœ€ | **50å€** |
| **APIèª¿ç”¨é »ç‡** | é«˜é »æ‰¹é‡ | ä½é »ç²¾æº– | **å¤§å¹…æ¸›å°‘** |

### âš¡ æ™‚é–“æ•ˆç‡æå‡
| ç’°ç¯€ | è™•ç†æ™‚é–“ | å„ªåŒ– |
|------|----------|------|
| **è³‡é‡‘è²»ç‡ç¯©é¸** | 1-5ms | DataFrameâ†’å­—å…¸æŸ¥è©¢ |
| **é»å·®ç²å–** | 1-3ms | WebSocketå„ªå…ˆ |
| **æœ€ä½³é¸æ“‡** | 2-10ms | æ™ºèƒ½æ’åº |
| **ç¸½è¨ˆç®—æ™‚é–“** | 5-20ms | **10-20å€æå‡** |

---

## ğŸ›ï¸ é—œéµé…ç½®åƒæ•¸

### æ ¸å¿ƒé–¾å€¼è¨­å®š
```python
MIN_FUNDING_RATE = 0.1    # æœ€å°æ·¨æ”¶ç›Šé–¾å€¼(%)
MAX_SPREAD = 5.0          # æœ€å¤§é»å·®é–¾å€¼(%)
ENTRY_BEFORE_SECONDS = 0.2 # é€²å ´æå‰æ™‚é–“(ç§’)
```

### æ™‚é–“æ§åˆ¶è¨­å®š
```python
CHECK_INTERVAL = 0.1                    # ä¸»å¾ªç’°é–“éš”(ç§’)
POST_SETTLEMENT_CHECK_PERIOD = 60       # çµç®—å¾Œé«˜é »æª¢æŸ¥æœŸ(ç§’)
POST_SETTLEMENT_CHECK_INTERVAL = 1      # çµç®—å¾Œæª¢æŸ¥é–“éš”(ç§’)
```

### ç·©å­˜ç­–ç•¥è¨­å®š
```python
# é»å·®ç·©å­˜ï¼š30ç§’å€‹åˆ¥ç·©å­˜
# WebSocketç·©å­˜ï¼šå¯¦æ™‚æ›´æ–°
# æ™‚é–“åŒæ­¥ï¼šæ¯5åˆ†é˜é‡æ–°åŒæ­¥
```

---

## ğŸš€ ç¸½çµï¼šæŒ‰éœ€ç²¾æº–ç­–ç•¥å„ªå‹¢

1. **ğŸ“Š ç²¾æº–ç¯©é¸**ï¼šä¸‰å±¤ç¯©é¸æ©Ÿåˆ¶ï¼Œå¾300+å€‹äº¤æ˜“å°ç²¾æº–é–å®š1å€‹æœ€ä½³ç›®æ¨™
2. **âš¡ æ•ˆç‡å„ªåŒ–**ï¼šAPIèª¿ç”¨æ¸›å°‘50å€ï¼Œè™•ç†é€Ÿåº¦æå‡10-20å€
3. **â° æ™‚é–“ç²¾æº–**ï¼šç¶²è·¯å»¶é²è£œå„Ÿï¼Œé€²å ´æ™‚æ©Ÿç²¾ç¢ºåˆ°100-300ms
4. **ğŸ”„ è³‡æºç¯€çœ**ï¼šæŒ‰éœ€æ›´æ–°ç­–ç•¥ï¼Œé¿å…99%ä¸å¿…è¦çš„è¨ˆç®—å’ŒAPIèª¿ç”¨
5. **ğŸ’¡ æ™ºèƒ½åŒ–**ï¼šåŸºæ–¼å¯¦éš›éœ€æ±‚è§¸ç™¼æ›´æ–°ï¼Œè€Œéç›²ç›®å®šæ™‚åŸ·è¡Œ

**æ ¸å¿ƒç†å¿µ**ï¼šåªåšå¿…è¦çš„äº‹ï¼Œåœ¨æ­£ç¢ºçš„æ™‚é–“ï¼Œç”¨æœ€é«˜æ•ˆçš„æ–¹å¼ï¼ 