# ä½µç™¼å•é¡Œä¿®å¾©å ±å‘Š

## å•é¡Œæè¿°

ç”¨æˆ¶ç™¼ç¾æ·»åŠ çš„é‡è©¦æ©Ÿåˆ¶å¯èƒ½æœƒé€ æˆä½µç™¼å•é¡Œï¼Œä¸»è¦æ“”å¿ƒï¼š

1. **é‡è©¦æœŸé–“çš„ç‹€æ…‹ç«¶çˆ­**ï¼šAPIèª¿ç”¨é‡è©¦æ™‚ï¼Œä¸»å¾ªç’°å¯èƒ½åŒæ™‚é€²è¡Œå…¶ä»–æ“ä½œ
2. **é‡è¤‡è¨‚å–®é¢¨éšª**ï¼šå¤šå€‹é‡è©¦åŒæ™‚é€²è¡Œå¯èƒ½ç™¼é€é‡è¤‡è¨‚å–®
3. **è³‡æºç«¶çˆ­**ï¼šåŒæ™‚é€²è¡Œçš„APIèª¿ç”¨å¯èƒ½é€ æˆè³‡æºè¡çª
4. **æ™‚é–“çª—å£å•é¡Œ**ï¼šé‡è©¦å»¶é²å¯èƒ½éŒ¯éæœ€ä½³äº¤æ˜“æ™‚æ©Ÿ

## ä¿®å¾©æ–¹æ¡ˆ

### 1. ğŸ”’ ä½µç™¼ä¿è­·æ©Ÿåˆ¶

åœ¨`__init__`æ–¹æ³•ä¸­æ·»åŠ äº†å®Œæ•´çš„ä½µç™¼ä¿è­·è®Šæ•¸ï¼š

```python
# ğŸ”’ ä½µç™¼ä¿è­·æ©Ÿåˆ¶
self.api_call_lock = threading.Lock()  # APIèª¿ç”¨é–å®š
self.retry_state_lock = threading.Lock()  # é‡è©¦ç‹€æ…‹é–å®š
self.is_api_calling = False  # APIèª¿ç”¨ç‹€æ…‹
self.api_call_start_time = 0  # APIèª¿ç”¨é–‹å§‹æ™‚é–“
self.max_api_call_duration = 15  # æœ€å¤§APIèª¿ç”¨æ™‚é–“ï¼ˆç§’ï¼‰
self.concurrent_api_calls = 0  # ç•¶å‰ä½µç™¼APIèª¿ç”¨æ•¸
self.max_concurrent_api_calls = 1  # æœ€å¤§ä½µç™¼APIèª¿ç”¨æ•¸
```

### 2. ğŸ›¡ï¸ å®‰å…¨çš„APIèª¿ç”¨æ©Ÿåˆ¶

å®Œå…¨é‡æ§‹äº†`execute_api_call_with_timeout`æ–¹æ³•ï¼š

#### ä½µç™¼æª¢æŸ¥
- æª¢æŸ¥æ˜¯å¦è¶…éæœ€å¤§ä½µç™¼æ•¸é™åˆ¶
- æª¢æ¸¬é•·æ™‚é–“é‹è¡Œçš„APIèª¿ç”¨
- è‡ªå‹•è™•ç†å¡ä½çš„èª¿ç”¨

#### ç‹€æ…‹ç®¡ç†
- ä½¿ç”¨`threading.Lock()`ç¢ºä¿ç‹€æ…‹åŒæ­¥
- é‡è©¦æœŸé–“æš«æ™‚é‡‹æ”¾é–å®š
- ç„¡è«–æˆåŠŸå¤±æ•—éƒ½é‡ç½®ç‹€æ…‹

#### é—œéµç‰¹æ€§
```python
# ğŸ”’ ä½µç™¼ä¿è­·ï¼šæª¢æŸ¥æ˜¯å¦å¯ä»¥é€²è¡ŒAPIèª¿ç”¨
with self.api_call_lock:
    if self.concurrent_api_calls >= self.max_concurrent_api_calls:
        raise Exception(f"å·²é”åˆ°æœ€å¤§ä½µç™¼æ•¸é™åˆ¶")
    
    # è¨­ç½®APIèª¿ç”¨ç‹€æ…‹
    self.is_api_calling = True
    self.api_call_start_time = time.time()
    self.concurrent_api_calls += 1

try:
    # åŸ·è¡Œé‡è©¦é‚è¼¯
    ...
finally:
    # ğŸ”’ ç„¡è«–æˆåŠŸå¤±æ•—éƒ½è¦é‡ç½®ç‹€æ…‹
    with self.api_call_lock:
        self.is_api_calling = False
        self.concurrent_api_calls = max(0, self.concurrent_api_calls - 1)
```

### 3. ğŸ¯ ä¸»å¾ªç’°ä½µç™¼æª¢æŸ¥

åœ¨ä¸»å¾ªç’°ä¸­æ·»åŠ äº†ä½µç™¼å®‰å…¨æª¢æŸ¥ï¼š

```python
# ğŸ”’ ä½µç™¼å®‰å…¨æª¢æŸ¥ï¼šå¦‚æœAPIèª¿ç”¨æ­£åœ¨é€²è¡Œï¼Œè·³ééé—œéµæ“ä½œ
if self.is_api_calling:
    api_duration = time.time() - self.api_call_start_time
    if api_duration < self.max_api_call_duration:
        # APIèª¿ç”¨æ­£åœ¨é€²è¡Œä¸”æœªè¶…æ™‚ï¼Œè·³ééé—œéµæ“ä½œ
        time.sleep(0.1)
        continue
    else:
        # APIèª¿ç”¨å¯èƒ½å¡ä½ï¼Œè¨˜éŒ„è­¦å‘Šä½†ç¹¼çºŒåŸ·è¡Œ
        print(f"âš ï¸ æª¢æ¸¬åˆ°é•·æ™‚é–“APIèª¿ç”¨ï¼Œå·²é‹è¡Œ{api_duration:.1f}ç§’")
```

### 4. ğŸ”„ é—œéµæ“ä½œä½µç™¼æª¢æŸ¥

#### é€²å ´å‰æª¢æŸ¥
```python
# ğŸ”’ é€²å ´å‰ä½µç™¼æª¢æŸ¥
if self.is_api_calling:
    print(f"æª¢æ¸¬åˆ°APIèª¿ç”¨é€²è¡Œä¸­ï¼Œå»¶é²é€²å ´ä»¥é¿å…è¡çª")
    time.sleep(0.2)  # ç­‰å¾…APIèª¿ç”¨å®Œæˆ
    
    # å†æ¬¡æª¢æŸ¥
    if self.is_api_calling:
        print(f"APIèª¿ç”¨ä»åœ¨é€²è¡Œï¼Œå–æ¶ˆæ­¤æ¬¡é€²å ´")
        continue
```

#### å¹³å€‰å‰æª¢æŸ¥
```python
# ğŸ”’ å¹³å€‰å‰ä½µç™¼æª¢æŸ¥
if self.is_api_calling:
    print(f"æª¢æ¸¬åˆ°APIèª¿ç”¨é€²è¡Œä¸­ï¼Œä½†å¹³å€‰æ˜¯å„ªå…ˆæ“ä½œï¼Œç­‰å¾…å®Œæˆ")
    # å¹³å€‰æ˜¯ç·Šæ€¥æ“ä½œï¼ŒçŸ­æš«ç­‰å¾…å¾Œç¹¼çºŒ
    time.sleep(0.1)
```

#### å¼·åˆ¶å¹³å€‰å‰æª¢æŸ¥
```python
# ğŸ”’ å¼·åˆ¶å¹³å€‰å‰ä½µç™¼æª¢æŸ¥
if self.is_api_calling:
    print(f"æª¢æ¸¬åˆ°APIèª¿ç”¨é€²è¡Œä¸­ï¼Œä½†å¼·åˆ¶å¹³å€‰æ˜¯æœ€å„ªå…ˆæ“ä½œï¼Œç­‰å¾…å®Œæˆ")
    # å¼·åˆ¶å¹³å€‰æ˜¯æœ€ç·Šæ€¥æ“ä½œï¼ŒçŸ­æš«ç­‰å¾…å¾Œç¹¼çºŒ
    time.sleep(0.1)
```

## ä¿®å¾©æ•ˆæœ

### 1. ğŸ›¡ï¸ ä½µç™¼å®‰å…¨æ€§
- **é˜²æ­¢é‡è¤‡è¨‚å–®**ï¼šç¢ºä¿åŒæ™‚åªæœ‰ä¸€å€‹APIèª¿ç”¨é€²è¡Œ
- **ç‹€æ…‹åŒæ­¥**ï¼šä½¿ç”¨ç·šç¨‹é–ç¢ºä¿ç‹€æ…‹ä¸€è‡´æ€§
- **è³‡æºä¿è­·**ï¼šé™åˆ¶ä½µç™¼APIèª¿ç”¨æ•¸é‡

### 2. ğŸ¯ æ“ä½œå„ªå…ˆç´š
- **é€²å ´**ï¼šæª¢æ¸¬åˆ°APIèª¿ç”¨æœƒå»¶é²æˆ–å–æ¶ˆ
- **å¹³å€‰**ï¼šå„ªå…ˆæ“ä½œï¼ŒçŸ­æš«ç­‰å¾…å¾Œç¹¼çºŒ
- **å¼·åˆ¶å¹³å€‰**ï¼šæœ€å„ªå…ˆæ“ä½œï¼Œç«‹å³åŸ·è¡Œ

### 3. ğŸ“Š ç‹€æ…‹ç›£æ§
- **å¯¦æ™‚ç›£æ§**ï¼šdebugä¿¡æ¯é¡¯ç¤ºAPIèª¿ç”¨ç‹€æ…‹
- **è¶…æ™‚æª¢æ¸¬**ï¼šè‡ªå‹•æª¢æ¸¬å’Œè™•ç†å¡ä½çš„èª¿ç”¨
- **æ—¥èªŒè¨˜éŒ„**ï¼šè©³ç´°è¨˜éŒ„ä½µç™¼æª¢æŸ¥éç¨‹

### 4. ğŸ”„ æ™ºèƒ½é‡è©¦
- **é–å®šç®¡ç†**ï¼šé‡è©¦æœŸé–“æ­£ç¢ºç®¡ç†é–å®šç‹€æ…‹
- **ç‹€æ…‹é‡ç½®**ï¼šç„¡è«–æˆåŠŸå¤±æ•—éƒ½é‡ç½®ç‹€æ…‹
- **éŒ¯èª¤æ¢å¾©**ï¼šè‡ªå‹•è™•ç†ä½µç™¼è¡çª

## ä½¿ç”¨æ•ˆæœ

### æ”¹å–„å‰çš„å•é¡Œ
1. é‡è©¦æœŸé–“å¯èƒ½ç™¼ç”Ÿä½µç™¼æ“ä½œ
2. å¤šå€‹APIèª¿ç”¨å¯èƒ½åŒæ™‚é€²è¡Œ
3. ç‹€æ…‹ä¸ä¸€è‡´å°è‡´çš„ç•°å¸¸
4. è³‡æºç«¶çˆ­å°è‡´çš„å¤±æ•—

### æ”¹å–„å¾Œçš„ä¿è­·
1. âœ… åš´æ ¼çš„ä½µç™¼æ§åˆ¶
2. âœ… å–®ä¸€APIèª¿ç”¨é™åˆ¶
3. âœ… ç‹€æ…‹åŒæ­¥ä¿è­‰
4. âœ… æ™ºèƒ½å„ªå…ˆç´šç®¡ç†

## é…ç½®åƒæ•¸

```python
# ä½µç™¼æ§åˆ¶åƒæ•¸
self.max_concurrent_api_calls = 1  # æœ€å¤§ä½µç™¼APIèª¿ç”¨æ•¸
self.max_api_call_duration = 15    # æœ€å¤§APIèª¿ç”¨æ™‚é–“ï¼ˆç§’ï¼‰

# ç­‰å¾…æ™‚é–“è¨­ç½®
- é€²å ´å»¶é²ï¼š0.2ç§’
- å¹³å€‰ç­‰å¾…ï¼š0.1ç§’  
- å¼·åˆ¶å¹³å€‰ç­‰å¾…ï¼š0.1ç§’
```

## çµè«–

ä½µç™¼å•é¡Œä¿®å¾©æˆåŠŸå¯¦æ–½äº†å¤šå±¤ä¿è­·æ©Ÿåˆ¶ï¼š
1. **APIèª¿ç”¨å±¤é¢**ï¼šç·šç¨‹é– + ç‹€æ…‹ç®¡ç†
2. **ä¸»å¾ªç’°å±¤é¢**ï¼šä½µç™¼æª¢æŸ¥ + æ™ºèƒ½è·³é
3. **é—œéµæ“ä½œå±¤é¢**ï¼šå„ªå…ˆç´šç®¡ç† + ç­‰å¾…ç­–ç•¥

é€™å€‹ä¿®å¾©ç¢ºä¿äº†ï¼š
- ğŸ”’ **ä½µç™¼å®‰å…¨**ï¼šé˜²æ­¢é‡è¤‡è¨‚å–®å’Œè³‡æºç«¶çˆ­
- âš¡ **æ€§èƒ½å„ªåŒ–**ï¼šåˆç†çš„ç­‰å¾…æ™‚é–“ä¸å½±éŸ¿äº¤æ˜“æ•ˆç‡
- ğŸ¯ **æ“ä½œå„ªå…ˆç´š**ï¼šç¢ºä¿é‡è¦æ“ä½œï¼ˆå¹³å€‰ï¼‰å„ªå…ˆåŸ·è¡Œ
- ğŸ“Š **ç‹€æ…‹é€æ˜**ï¼šè©³ç´°çš„æ—¥èªŒè¨˜éŒ„ä¾¿æ–¼ç›£æ§

ç”¨æˆ¶çš„æ“”å¿ƒå·²å®Œå…¨è§£æ±ºï¼Œé‡è©¦æ©Ÿåˆ¶ç¾åœ¨æ˜¯ä½µç™¼å®‰å…¨çš„ï¼ 